parameters:
  - name: jobName
    type: string
  - name: environment # dev/live
    type: string

variables:
  azureSubscription: Infra-${{ parameters.environment }}-global-Demos
  resourceGroupName: rg-${{ parameters.environment }}-global-demos
  databaseName: sqldb-${{ parameters.environment }}-demos-headless-demo

jobs:
  - job: ${{ parameters.jobName }}
    displayName: Reset ${{ parameters.environment }}
    steps:
      - task: AzureAppServiceManage@0
        displayName: "Stop App Service"
        inputs:
          azureSubscription:  ${{ variables.azureSubscription }}
          Action: "Stop Azure App Service"
          WebAppName: "azapp-${{ parameters.environment }}-demos-headless-demo-umbraco"

      - task: AzureCLI@2
        name: ExportAzureServiceConnectionCredentials
        displayName: "Export Service Connection Credentials"
        inputs:
          azureSubscription:  ${{ variables.azureSubscription }}
          scriptType: pscore
          scriptLocation: inlineScript
          addSpnToEnvironment: true
          inlineScript: |
            $SUBSCRIPTION_ID = az account show --query "id" --output tsv
            Write-Host "##vso[task.setvariable variable=tenant_id]$env:tenantId"
            Write-Host "##vso[task.setvariable variable=subscription_id]$SUBSCRIPTION_ID"
            Write-Host "##vso[task.setvariable variable=client_id]$env:servicePrincipalId"
            Write-Host "##vso[task.setvariable variable=client_secret]$env:servicePrincipalKey"
      
      - task: AzurePowerShell@5
        inputs:
          azureSubscription:  ${{ variables.azureSubscription }}
          ScriptType: "InlineScript"
          Inline: |
            Write-Host "Remove existing database"
            Remove-AzSqlDatabase -ResourceGroupName "${{ variables.resourceGroupName }}" `
                                  -ServerName "${{ variables.databaseName }}" `
                                  -DatabaseName "${{ variables.databaseName }}"
            
            Write-Host "Create new empty database"
            $database = New-AzSqlDatabase -ResourceGroupName "${{ variables.resourceGroupName }}" `
                          -ServerName "${{ variables.databaseName }}"" `
                          -DatabaseName "${{ variables.databaseName }}" `
                          -RequestedServiceObjectiveName "S0" `
                          -Edition "Standard"
            
            Write-Host "Import database from .bacpac"
            $importRequest = New-AzSqlDatabaseImport -ResourceGroupName "${{ variables.resourceGroupName }}" `
                    -ServerName "${{ variables.databaseName }}"" `
                    -DatabaseName "${{ variables.databaseName }}"" `
                    -DatabaseMaxSizeBytes "database-size-in-bytes" `
                    -StorageKeyType "StorageAccessKey" `
                    -StorageKey "$env:STORAGE_ACCESS_KEY" `
                    -StorageUri "${env:DB_BACPAC_URL}" `
                    -Edition "Standard" `
                    -ServiceObjectiveName "S0" `
                    -AdministratorLogin "$env:DATABASE_ADMIN" `
                    -AdministratorLoginPassword "$env:DATABASE_PASSWORD"
          preferredAzurePowerShellVersion: "5"
        env:
          STORAGE_ACCESS_KEY: $(SECRET_STORAGE_ACCESS_KEY)
          DATABASE_ADMIN: $(SECRET_DATABASE_ADMIN)
          DATABASE_PASSWORD: $(SECRET_DATABASE_PASSWORD)

      - task: AzureAppServiceManage@0
        displayName: "Start App Service"
        inputs:
          azureSubscription:  ${{ variables.azureSubscription }}
          Action: "Start Azure App Service"
          WebAppName: "azapp-${{ parameters.environment }}-demos-headless-demo-umbraco"
